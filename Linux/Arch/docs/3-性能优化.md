# <center>性能优化</center>

# 显卡优化

1. N 卡动态功耗调节: `sudo systemctl enable --now nvidia-powerd.service`
2. 软件商城安装 LACT, 进行显卡 offset

# swap / zswap / zram

交换空间 swap 会相对频繁地读写硬盘, 降低寿命.  
所以可以利用**内存压缩**技术, 常见方法: zswap 和 zram

zswap 是 swap 的压缩缓存层, 压缩后才写硬盘 swap  
zram 是用内存创建一个压缩块设备作为 swap, 不依赖硬盘

```bash
# 参考 arch wiki (Power_management/Suspend_and_hibernate)
# * 优先使用zram, 其次swap file, 关闭zswap
# * 休眠时zram写到swap中, 并正常启动

# 1. 可选: 若内存够用且不需要休眠功能, 可考虑删除swap, 只靠zram
# 如果不关闭swap, 最好保证swap大小>=内存, 保证休眠功能正常
sudo swapoff /swap/swapfile # 关闭swap
sudo rm /swap/swapfile      # 删除swap file
sudo vim /etc/fstab         # 编辑fstab, 删掉swap相关的内容

# 2. 禁用zswap
sudo vim /etc/default/grub
# 找到GRUB_CMDLINE_LINUX_DEFAULT, 加入 zswap.enabled=0

# 3. 安装配置zram
sudo pacman -S zram-generator
sudo vim /etc/systemd/zram-generator.conf # 注: zram-size 是压缩前的大小
# [zram0]
# zram-size = ram / 2
# compression-algorithm = zstd

# 4. 重新生成grub配置
sudo grub-mkconfig -o /efi/grub/grub.cfg
reboot # 重启

# 5. 验证
systemctl status systemd-zram-setup@zram0.service # 查看zram服务
sudo zramctl                                      # 查看zram情况
sudo grep -R . /sys/kernel/debug/zswap/           # 验证zswap关闭
swapon --show                                     # 查看swap情况, 优先级(zram > swapfile)
systemctl hibernate                               # 进入休眠, 测试功能
journalctl -b | grep -i resume                    # 查看休眠启动成功日志
# 也可以安装stress-ng, 制造内存压力, 然后watch -n 1 swapon --show测试

# 其他可选优化:
# 修改swappiness: 匿名页和文件页的回收比例修正值, 默认60, 均衡
# 设置memory.low: 设定某组应用超过多少内存前尽量少回收. 策略更准, 但复杂
```

# 替换 zen 内核

linux zen 内核针对桌面端优化, 不过会略微增加功耗

```bash
# 安装内核和头文件
sudo pacman -S linux-zen linux-zen-headers
# 安装显卡驱动, 用nvidia-dkms替换nvidia驱动
sudo pacman -S nvidia-dkms
# 重新生成grub
sudo grub-mkconfig -o /efi/grub/grub.cfg
# 重启
reboot # # 重启时在grub的arch advance启动项里选择zen
# 确认正常运行后删除stable内核
sudo pacman -R linux linux-headers
# 重新生成grub
sudo grub-mkconfig -o /efi/grub/grub.cfg
```
