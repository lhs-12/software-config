# <center>桌面环境</center>

# 字体安装

先装字体, 后面使用 fontconfig 配置管理  
参考: [fontconfig 治理字体](https://catcat.cc/post/2021-03-07/)

> 注: locale 的 LANG 变量 , 会影响字体的选择, 注意检查

```bash
# 主要组合: MiSans, 霞鹜新致宋(Screen), Iosevka Term, Nerd Symbols Only
# 合成字体备用: Sarasa Gothic, Maple
# Noto字体: Emoji, CJK异体字, 小语种...
# 已满足GB18030-2022, 可选Unicode 17标准字体兜底: 遍黑, 文津宋, 天珩, 字雲...

yay -S ttf-misans{,-tc,-l3}               # 小米黑体中文(常用字+繁体+生僻字)
yay -S ttf-lxgw-neo-zhisong-screen        # 霞鹜新致宋(Screen)
pacman -S ttf-nerd-fonts-symbols{,-mono}  # Nerd Fonts Symbols Only
pacman -S noto-fonts{,-cjk,-emoji,-extra} # Noto全家桶
pacman -S ttc-iosevka ttf-sarasa-gothic   # Iosevka系列
pacman -S ttf-maplemono-nf-cn-unhinted    # Maple Font
pacman -S ttf-jigmo                       # 字雲字体(日本字形)

# 其他可选装: 一點明體, 朱雀仿宋...
```

# 显卡驱动

```bash
# 1. 安装内核头文件(某些驱动/软件用来编译模块)
pacman -S linux-headers # 视内核不同替换, 比如zen内核用linux-zen-headers

# 2. 安装显卡驱动

# 2.1 Nvidia
# 查看显卡family: https://nouveau.freedesktop.org/CodeNames.html
# 查驱动程序: https://wiki.archlinux.org/title/NVIDIA
# nvidia-open是内核模块开源, 不是完全开源驱动.
# 非标准内核安装的驱动包后缀不一样, 比如zen要装nvidia-open-dkms, 具体看wiki
# pacman -S --needed nvidia-open nvidia-utils lib32-nvidia-utils vulkan-icd-loader lib32-vulkan-icd-loader

# 2.2 AMD
# https://wiki.archlinux.org/title/AMDGPU
# AMD 不需要自己安装驱动, 已经由linux-firmware和mesa提供
# 另外加上AMD的vulkan(图形计算API接口), 还有GStreamer的包
pacman -S --needed mesa lib32-mesa xf86-video-amdgpu vulkan-radeon lib32-vulkan-radeon gst-plugin-va

# 2.3 Intel
# https://wiki.archlinux.org/title/Intel_graphics
# pacman -S --needed mesa lib32-mesa vulkan-intel lib32-vulkan-intel gst-plugin-va intel-media-driver

# 3. 硬件编解码
# https://wiki.archlinux.org/title/Hardware_video_acceleration

# 3.1 NVIDIA: 由nvidia-utils和libva-nvidia-driver提供
# pacman -S libva-nvidia-driver
# 还可以替换为nvidia-vaapi-driver，据wiki说功耗更低(这个包在archlinuxcn)

# 3.2 AMD
# mesa已提供

# 3.3 Intel
# Broadwell往后装intel-media-driver, 旧的装libva-intel-driver. 具体看wiki

reboot # 重启激活字体和显卡驱动

# 3.4 可选: 验证硬件编解码功能
pacman -S libva-utils
vainfo # 验证命令
# 多显卡用户要改环境变量指定使用的显卡来验证:
# LIBVA_DRIVER_NAME=xxx vainfo # xxx改成 nvidia / radeonsi

# 4. 安装 OpenCL
# https://wiki.archlinux.org/title/General-purpose_computing_on_graphics_processing_units#Runtime

# 4.1 NVIDIA
# sudo pacman -S opencl-nvidia lib32-opencl-nvidia

# 4.2 AMD / Intel
sudo pacman -S opencl-mesa lib32-opencl-mesa # 通用版(非最佳性能版)

# 5. 关于混合模式下用独显运行
# https://wiki.archlinuxcn.org/wiki/混合图形技术
# https://wiki.archlinuxcn.org/wiki/PRIME
# https://wiki.archlinuxcn.org/wiki/NVIDIA_Optimus
# KDE桌面环境: 开始菜单右键编辑应用程序在高级页面设置用独显运行
# 其他看文档

# 双显卡的时候, 确保电源管理正确关闭独立显卡
# https://github.com/Askannz/optimus-manager/wiki/A-guide--to-power-management-options

# 6. 关于显卡切换
# KDE 桌面可以用envycontrol 和 Optimus GPU Switcher.
# 目前Wayland下不完善, 只能从混合模式切换到核显模式. 独显直连需要手动进BIOS调整
# 具体看文档
```

# KDE 安装配置

[KDE Wiki](https://wiki.archlinux.org/title/KDE)

KDE 基本安装启动:

```bash
# plasma-meta: KDE ; konsole: 终端 ; dolphin:文件管理器 ; flatpak-kcm: 包安装GUI
# kate: 文本查看 ; ark: 压缩工具 ; partitionmanager : 磁盘管理 ; ksystemlog: 系统日志查看
pacman -S plasma-meta konsole dolphin flatpak-kcm kate ark partitionmanager ksystemlog
# 安装选择选项: ffmpeg 和 pipewire-jack

# 启动桌面
systemctl start sddm
# 开机自启
sudo systemctl enable sddm

# 音视频固件和服务
sudo pacman -S --needed sof-firmware alsa-ucm-conf alsa-firmware # 可选: 音视频设备固件
sudo pacman -S --needed pipewire wireplumber pipewire-pulse pipewire-alsa pipewire-jack # 音视频服务
systemctl --user enable --now pipewire pipewire-pulse wireplumber # 启用服务
sudo pacman -S --needed pavucontrol # 可选: GUI管理

# 启用蓝牙
sudo pacman -S --needed bluez
sudo systemctl enable --now bluetooth

# 性能切换工具(三挡: performance ; balance ; powersave. 一般balance可以了)
sudo pacman -S --needed power-profiles-daemon
sudo systemctl enable --now power-profiles-daemon

# 休眠功能(Hibernate, 如果需要休眠功能, 且前面已经设置了硬盘swap)
# 如果手动安装Arch, /etc/mkinitcpio.conf 的 HOOKS 里面会包含 systemd , 不需要处理
# 如果没systemd, 则参考wiki修改(Power_management/Suspend_and_hibernate)

# 生成home下目录(如果没有的话)
xdg-user-dirs-update

# issue: KDE开机可能卡住，需要重启sddm
# 原因: 显卡驱动没加载完sddm就加载导致的卡死, 让sddm晚点加载可以解决
# sudo systemctl edit sddm.service
# [Service]
# ExecStartPre=/bin/sleep 2
# sudo systemctl daemon-reload
```

KDE 配置:

```bash
# 系统设置 -> 修改为深色主题, 换壁纸
# 系统设置 -> 颜色和主题 -> 登录屏幕(SDDM) -> 选其他主题点应用, 再切回微风主题, 换壁纸, 应用
# 系统设置 -> 安全和隐私 -> 锁屏 -> 配置外观 -> 换壁纸
# 系统设置 -> 文字和字体 -> 修改系统字体
# 系统设置 -> 输入和输出 -> 键盘 -> 快捷键, 按需修改 (用dotfiles管理)
# 系统设置 -> 输入和输出 -> 无障碍辅助, 关闭抖动后放大光标
# 系统设置 -> 默认应用程序 -> 按需修改
# 系统设置 -> 鼠标和触摸板 -> 触摸板 -> 勾选反向滚动(自然滚动)
# 右键任务栏 -> 安装部件 "Panel Colorizer" -> 配置透明任务栏: 预设用 "Transparent", 全屏和最大化窗口用 "ChromeOS"
```

# 代理配置

```bash
yay -S v2rayn-bin
# 右上角修改语言, 主题
# 设置 -> 参数设置 -> v2rayN设置 -> "开机启动", "启动后隐藏窗口", 字体MiSans
# 订阅分组 -> 添加链接
# 帮助 -> 检查更新
# 设置 -> 路由设置 -> "一键导入规则集", 再导入自定义配置, 调整顺序
```

下面步骤为手动下载安装, 无需执行, 仅供参考
```bash
unzip -n v2rayN-linux-64.zip -d . # 下载包后解压
sudo mv v2rayN-linux-64/ /opt/ # 移动到opt目录
# 创建desktop文件
cat > ~/.local/share/applications/v2rayN.desktop <<'EOF'
[Desktop Entry]
Type=Application
Name=v2rayN
Exec=/opt/v2rayN-linux-64/v2rayN
Icon=/opt/v2rayN-linux-64/v2rayN.png
Terminal=false
Categories=Network;
EOF
# 创建开机启动超链接
ln -sf ~/.local/share/applications/v2rayN.desktop ~/.config/autostart/
# 取消超链接
unlink ~/.config/autostart/v2rayN.desktop
```

# 修改键盘映射

```bash
# xremap 方案
# 以下步骤适用于KDE, 其他情况参考官方文档
yay -S xremap-kde-bin
# 1. xremap 默认需要 sudo 权限, 通过下面步骤让其免去sudo
# 1.1. 启用uinput模块
lsmod | grep uinput # 检查模块是否已加载
echo uinput | sudo tee /etc/modules-load.d/uinput.conf # 如果为空, 创建模块加载文件
# 1.2. 添加 udev 权限规则(让普通用户也能访问 /dev/uinput)
echo 'KERNEL=="uinput", GROUP="input", TAG+="uaccess"' | sudo tee /etc/udev/rules.d/99-input.rules
# 1.3. 把当前用户加入 input 组
sudo gpasswd -a $USER input

# 2. 开机自启 (无需执行, 配置文件通过dotfiles管理)
# 2.1. 可通过 systemctl 自启动
# 编辑 ~/.config/systemd/user/xremap.service
# systemctl --user start xremap
# systemctl --user enable xremap
# 2.2. 官方更推荐用 autostart desktop 确保正常启动
# systemd --user 服务可能太早启动, 导致 xremap 无法检测到窗口管理器
# 编辑 ~/.config/autostart/xremap.desktop
```

```bash
# 废弃方案: keyd , 会额外触发ctrl意外切换输入法
sudo pacman -S keyd
sudo vim /etc/keyd/default.conf
sudo systemctl enable keyd --now

# [ids]
# *
# [main]
# capslock = overloadt(ctrl_vim, esc, 200)
# [ctrl_vim:C]
# h = left
# j = down
# k = up
# l = right
# n = home
# m = end
# esc = capslock
```

# 输入法

```bash
# 1. 安装
sudo pacman -S fcitx5-im fcitx5-rime rime-ice-git
# 2. 修改配置文件(dotfiles管理)
#   ~/.config/fcitx5 和 ~/.local/share/fcitx5/rime/
# 3. 编辑环境变量
sudo vim /etc/environment # KDE环境写入: XMODIFIERS=@im=fcitx
# 4. 系统设置 -> 输入和输出 -> 键盘 -> 虚拟键盘, 用 Fcitx5 Wayland 启动器
# 5. KDE系统设置里的输入法设置是fcitx5集成的GUI界面(~/.config/fcitx5), 交给dotfiles即可

# 若要删除fcitx5
# sudo pacman -Rns fcitx5-im fcitx5-rime rime-ice-git
# sudo rm -rf ~/.config/fcitx* ~/.local/share/fcitx*
# sudo vim /etc/environment # 清理相关环境变量

# 使用异常的解决办法:
#
# KDE, hyprland, niri, sway...这些基于wayland运行的图形化环境,
# 设置 GTK 和 QT 的 IM_MODULE 全局变量, 会导致输入法闪烁和位置错误等问题,
# 但是不设置的话, 在 xwayland 应用和 electron 应用会出现输入法异常,
# 所以需要为出现异常的应用单独进行输入法设置.
#
# 已知问题: 1.漏字;2.删不掉输入框最后一个字母;3.卡顿;4.删除输入框字母时删除右侧写好的字;5.无法使用输入法
#
# 修改locale的 LANG 为英文, LC_MESSAGES 为中文, 使界面中文同时避免中文locale导致的输入法异常:
sudo vim /etc/locale.conf # 修改系统级文件
vim ~/.config/locale.conf # 用户级别文件
vim ~/.config/plasma-localerc # KDE Plasma 语言配置 (放入dotfiles管理)
# 写入下面这两行
# LANG=en_US.UTF-8
# LC_MESSAGES=zh_CN.UTF-8
# 
# 备注: 其他方法如设置 IM_MODULE 或 --ozone-platform, 漏字问题确实没了, 但会出现其他问题
#
# 无法使用输入法的解决方式
# 1. 从快捷方式打开(.desktop)
#   1.1. 对于QT和GTK应用
#       打开菜单编辑器, 给程序设置环境变量: GTK_IM_MODULE=fcitx QT_IM_MODULE=fcitx
#   1.2. 对于 chromium 和 electron 应用
#       在 Linux QQ, %U 前面添加 --ozone-platform=wayland
#       不行的话设置 --enable-features=UseOzonePlatform --ozone-platform=wayland --enable-wayland-ime
# 2. 从终端命令打开(给shell设置alias, 以下, fish 不适用)
#   2.1. 适用于 bash/zsh, 修改 .bashrc 或 .zshrc, 示例如下:
#       对于QT或GTK应用: alias typora='GTK_IM_MODULE=fcitx QT_IM_MODULE=fcitx typora'
#       chromium 和 electron 应用: alias code='code --enable-features=UseOzonePlatform --ozone-platform=wayland --enable-wayland-ime'
#   2.2. 适用于 fish(abbr或function)
#       abbr typora 'GTK_IM_MODULE=fcitx QT_IM_MODULE=fcitx typora'
#       abbr code 'code --enable-features=UseOzonePlatform --ozone-platform=wayland --enable-wayland-ime'
#       function code --description ‘启动code’
#           exec code --enable-features=UseOzonePlatform --ozone-platform=wayland --enable-wayland-ime $argv
#       end
#
# 其他: 偶尔一些软件版本支持不好, 需要加参数--wayland-text-input-version=3 或者 2
```

# 常用软件安装

```bash
# 常用软件
# wezterm: 终端; firefox: 浏览器; speech-dispatcher: ; keepassxc: 密码管理; kcalc: 计算器; kfind: 文件查找;
# kcolorchooser: 取色器; KTorrent: BT下载; gwenview: 看图; easyeffects: 音频工具; haruna: 视频播放; flameshot: 贴图
sudo pacman -S --needed wezterm firefox speech-dispatcher keepassxc kcalc kfind kcolorchooser ktorrent gwenview easyeffects haruna flameshot

# flameshot 的KDE窗口置顶规则在 ~/.config/kwinrulesrc 中定义 (dotfiles管理)
# 手动操作: 系统设置 -> 键盘 -> 快捷键 -> 添加flameshot, 设置F1为全局截图按键

# Firefox 配置
# 设置: 关闭翻译总弹窗, 关闭密码保存提示, 选择垂直标签栏
# 插件: 沉浸式翻译, Tampermonkey, AdGuard, Gesturefy, KeePassXC, Vimium, Plasma Integration, Disable WebRTC
# 添加搜索引擎:
# https://github.com/search?q=%s&type=repositories
# https://www.youtube.com/results?search_query=%s

# AUR软件
# WPS及其字体库
yay -S wps-office-cn wps-office-mui-zh-cn
# QQ, 微信, QQ音乐
yay -S linuxqq-appimage wechat-appimage qqmusic-bin
yay -S yesplaymusic # 网易云, 还能用 go-musicfox-bin (TUI)
# VSCode
yay -S visual-studio-code-bin

# Flatpak
# Warehouse: 管理flatpak的源/软件/属性/数据... ; Flatseal: 管理flatpak应用的权限, 环境变量...
flatpak install flathub io.github.flattool.Warehouse com.github.tchx84.Flatseal

# Appimage
yay -S appimagelauncher # AppImage管理器
```
