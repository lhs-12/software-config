#!/bin/bash

# ===============================================================
# Arch Linux 系统更新助手
# ===============================================================
# 【功能说明】
# 01. 支持从 Arch Linux 官方/中文社区获取最新新闻资讯
# 02. 智能解析新闻并高亮显示需要"手动干预"的警告信息
# 03. 等待用户确认后执行系统更新
# 04. 自动检测并使用 AUR 助手 (paru 或 yay)
# 05. 智能更新 GPG 密钥环 (keyring)
# 06. 自动更新 Flatpak 应用
# 07. 更新后自动执行 GRUB 配置更新
# 08. 自动请求并后台保持 sudo 权限
# 09. 自动检测系统语言实现多语言支持 (中/英)
# ===============================================================
# 【命令行参数】
# --ui-lang      zh|en        指定脚本交互语言(中/英)
# --news-source  official|cn  指定新闻源(官方/中文社区)
# --count N                   限制最多显示的新闻条数
# --help, -h                  显示帮助信息
# ===============================================================

set -Eeuo pipefail
trap 'echo "ERROR at line $LINENO: $BASH_COMMAND" >&2' ERR
# ------------------------------
# 1. Default parameters
# ------------------------------
# Default news count limit
COUNT_LIMIT=15
# Default news source
NEWS_SOURCE="official"
# Default UI language
UI_LANG=$([[ ${LC_ALL:-${LC_MESSAGES:-${LANG}}} == zh* ]] && echo zh || echo en)

# ------------------------------
# 2. Argument parsing (GNU-style)
# ------------------------------
usage() {
    cat <<EOF
Usage: $(basename "$0") [options]

Options:
  --ui-lang zh|en            UI language (default: auto)
  --news-source official|cn  News source (default: official)
  --count N                  Max number of news items (default: 15)
  --help, -h                 Show this help and exit
EOF
}
while [ $# -gt 0 ]; do
    case "$1" in
        --ui-lang)
            [ -n "$2" ] && UI_LANG="$2" shift 2 || { echo "Error: Missing arg for --ui-lang"; exit 1; }
            ;;
        --news-source)
            [ -n "$2" ] && NEWS_SOURCE="$2" shift 2 || { echo "Error: Missing arg for --news-source"; exit 1; }
            ;;
        --count)
            [ -n "$2" ] && COUNT_LIMIT="$2" shift 2 || { echo "Error: Missing arg for --count"; exit 1; }
            ;;
        --help|-h)
            usage; exit 0
            ;;
        *)
            printf "Unknown option: %s\n" "$1"; usage; exit 1
            ;;
    esac
done

# ------------------------------
# 3. Localization Logic
# ------------------------------
LANG_TABLE='
TAG_INFO         | [INFO]                                   | [消息]
TAG_SUCCESS      | [OK]                                     | [成功]
TAG_WARN         | [WARN]                                   | [注意]
TAG_ERROR        | [ERROR]                                  | [错误]

MSG_REQ_SUDO     | Requesting sudo...                       | 正在请求管理员权限以更新系统...
MSG_SUDO_FAIL    | Sudo privileges required. Exiting...     | 需要管理员权限才能更新系统。已退出。
MSG_NO_HELPER    | No AUR helper found (paru or yay)        | 未找到 AUR 助手 (paru 或 yay)
MSG_PREPARING    | Preparing update with %s...              | 准备使用 %s 更新系统...
MSG_FETCHING     | Fetching news...                         | 正在获取 Arch Linux 新闻...
MSG_NEWS_HEADER  | Recent {0} Arch Linux news items:        | 最近 {0} 条 Arch Linux 新闻：
MSG_CONFIRM      | Proceed with %s? [Y/n]                   | 确认使用 %s 继续更新吗？[Y/n]
MSG_CANCEL       | Update cancelled.                        | 更新已取消。
MSG_ERR_FETCH    | Failed to fetch news                     | 获取新闻失败（网络或源错误）
MSG_FORCE_ASK    | Force update anyway? [y/N]               | 是否忽略新闻强制更新？[y/N]
MSG_FORCING      | Forcing update...                        | 正在强制更新...
MSG_EXIT         | Safe exit.                               | 安全退出。

MSG_STEP_1       | [1/4] Sync DB & Keyrings                 | [1/4] 同步数据库并更新密钥环...
MSG_KEYRING_OK   | DB & Keyrings synced.                    | 数据库与密钥环已同步。
MSG_KEYRING_WARN | Keyring issues detected...               | 密钥环更新遇到问题，继续尝试系统更新...
MSG_STEP_2       | [2/4] Upgrading system                   | [2/4] 正在升级系统...
MSG_STEP_3       | [3/4] Checking Flatpak updates           | [3/4] 检查 Flatpak 更新...
MSG_STEP_4       | [4/4] Updating GRUB                      | [4/4] 更新 GRUB 配置...
MSG_GRUB_OK      | GRUB updated.                            | GRUB 更新成功。
MSG_GRUB_FAIL    | GRUB update failed.                      | GRUB 更新失败。
MSG_GRUB_MISSING | Skip GRUB update (grub-mkconfig missing) | 跳过 GRUB 更新(grub-mkconfig 缺失)
'
while IFS='|' read -r v e c; do
    v=$(printf '%s' "$v" | sed 's/^ *//;s/ *$//')
    e=$(printf '%s' "$e" | sed 's/^ *//;s/ *$//')
    c=$(printf '%s' "$c" | sed 's/^ *//;s/ *$//')
    [ -z "$v" ] && continue
    case "$v" in \#*) continue ;; esac
    [ "$UI_LANG" = "zh" ] && eval "$v=\$c" \
                          || eval "$v=\$e"
done <<EOF
$LANG_TABLE
EOF

# ------------------------------
# 4. Define Logging Functions
# ------------------------------
NC=$'\033[0m'
H_BLUE=$'\033[1;34m'
H_GREEN=$'\033[1;32m'
H_YELLOW=$'\033[1;33m'
H_RED=$'\033[1;31m'
_info()    { printf "%s%-12s%s %s\n" "${H_BLUE}"   "${TAG_INFO}"    "${NC}" "$1"; }
_success() { printf "%s%-12s%s %s\n" "${H_GREEN}"  "${TAG_SUCCESS}" "${NC}" "$1"; }
_warn()    { printf "%s%-12s%s %s\n" "${H_YELLOW}" "${TAG_WARN}"    "${NC}" "$1"; }
_error()   { printf "%s%-12s%s %s\n" "${H_RED}"    "${TAG_ERROR}"   "${NC}" "$1"; exit 1; }

# ------------------------------
# 5. Request Privileges
# ------------------------------
_info "$MSG_REQ_SUDO"
if ! sudo -v; then
    _error "$MSG_SUDO_FAIL"
fi
# Keep sudo alive in background
( while true; do sudo -n true 2>/dev/null || exit; sleep 60 || exit; done ) &
SUDO_PID=$!
trap 'kill -- -$SUDO_PID 2>/dev/null || true' EXIT INT TERM

# ------------------------------
# 6. Check AUR Helper
# ------------------------------
command -v paru &>/dev/null && UPDATE_CMD=paru ||
command -v yay  &>/dev/null && UPDATE_CMD=yay  ||
_error "$MSG_NO_HELPER"

# ------------------------------
# 7. Update Function
# ------------------------------
perform_update() {
    # Step 1: Sync DB & Update keyrings
    _info "$MSG_STEP_1"
    KEYRING_TARGETS="archlinux-keyring"
    grep -q "^\[archlinuxcn\]" /etc/pacman.conf && KEYRING_TARGETS+=" archlinuxcn-keyring"

    if sudo pacman -Sy --needed --noconfirm ${KEYRING_TARGETS}; then
        _success "$MSG_KEYRING_OK"
    else
        _warn "$MSG_KEYRING_WARN"
    fi

    # Step 2: Upgrade system
    _info "$MSG_STEP_2"
    # Using -y to ensure database and packages are fully consistent
    $UPDATE_CMD -Syu

    # Step 3: Flatpak
    if command -v flatpak >/dev/null 2>&1; then
        _info "$MSG_STEP_3"
        flatpak update -y # -y for silent update
    fi

    # Step 4: Update GRUB
    _info "$MSG_STEP_4"
    if ! command -v grub-mkconfig >/dev/null 2>&1; then
        _warn "$MSG_GRUB_MISSING"
    elif sudo env LANG=en_US.UTF-8 grub-mkconfig -o /boot/grub/grub.cfg; then
        _success "$MSG_GRUB_OK"
    else
        _warn "$MSG_GRUB_FAIL"
    fi
}

# ------------------------------
# 8. Main Execution
# ------------------------------
_info "$(printf "$MSG_PREPARING" "$UPDATE_CMD")"
_info "$MSG_FETCHING"

# Python script for news parsing
PYTHON_SCRIPT=$(cat <<'EOF'
import sys
import xml.etree.ElementTree as ET
try:
    limit = int(sys.argv[1])
    header_template = sys.argv[2]
    sys.stdin.reconfigure(encoding='utf-8')
    raw_data = sys.stdin.read()
    if not raw_data.strip(): sys.exit(1)
    root = ET.fromstring(raw_data)
    items = root.findall('./channel/item')[:limit]
    print(f'\n\033[1;33m{header_template.format(len(items))}\033[0m\n')
    for item in items:
        title = item.find('title').text
        pub_date = item.find('pubDate').text
        date_str = pub_date[:16]
        check_text = title.lower()
        if any(x in check_text for x in ['intervention', 'manual', '手动', '干预']):
            color = '\033[1;31m'; prefix = '!!!'
        else:
            color = '\033[1;32m'; prefix = ''
        print(f'{color}[{date_str}] {prefix}{title}\033[0m')
except Exception as e:
    sys.stderr.write(f'\nParse Error: {e}\n')
    sys.exit(1)
EOF
)

# Fetch news and pipe to python for processing
NEWS_URL="https://archlinux.org/feeds/news/"
[ "$NEWS_SOURCE" = "cn" ] && NEWS_URL="https://www.archlinuxcn.org/category/news/feed/"

if curl -sS -L --connect-timeout 15 -A "Mozilla/5.0" "$NEWS_URL" \
    | python -c "$PYTHON_SCRIPT" "$COUNT_LIMIT" "$MSG_NEWS_HEADER"; then
    # News fetched successfully
    printf "\n"
    printf "$MSG_CONFIRM" "$UPDATE_CMD"
    read -r confirm
    case "$confirm" in
        [Yy]*|"" ) perform_update ;;
        * ) _warn "$MSG_CANCEL"; exit 0 ;;
    esac
else
    # Failed to fetch or parse news
    printf "\n"
    _warn "$MSG_ERR_FETCH"
    printf "$MSG_FORCE_ASK"
    read -r force_confirm
    case "$force_confirm" in
        [Yy]* ) _warn "$MSG_FORCING"; perform_update ;;
        * ) _info "$MSG_EXIT"; exit 1 ;;
    esac
fi
