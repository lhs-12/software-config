#!/bin/bash

# ===============================================================
# Arch Linux 系统清理助手
# ===============================================================
# 【功能说明】
# 1. 移除孤儿软件包 (Orphans)
# 2. 清理 Pacman 软件包缓存 (保留安装包，删除旧版本)
# 3. 清理残留的下载目录 (download-*)
# 4. 清理 Systemd 日志 (只保留最近 2 周)
# 5. 清空用户回收站 (Trash) 和缩略图缓存 (Thumbnails)
# 6. 移除未使用的 Flatpak 运行时
# ===============================================================

set -Eeuo pipefail
trap 'echo "ERROR at line $LINENO: $BASH_COMMAND" >&2' ERR
# ------------------------------
# 1. Default parameters
# ------------------------------
SKIP_CONFIRM=false
UI_LANG=$([[ ${LC_ALL:-${LC_MESSAGES:-${LANG}}} == zh* ]] && echo zh || echo en)

# ------------------------------
# 2. Usage / Argument parsing
# ------------------------------
usage() {
    cat <<EOF
Usage: $(basename "$0") [options]

Options:
  --ui-lang zh|en    UI language (default: auto)
  --yes, -y          Skip confirmation prompt (non-interactive mode)
  --help, -h         Show this help and exit
EOF
}
while [[ $# -gt 0 ]]; do
    case "$1" in
        --ui-lang)
            case "$2" in
                zh|en) UI_LANG="$2"; shift 2 ;;
                *) printf "Error: --ui-lang requires zh or en.\n" >&2; exit 1 ;;
            esac
            ;;
        --yes|-y)
            SKIP_CONFIRM=true
            shift
            ;;
        --help|-h)
            usage
            exit 0
            ;;
        *)
            printf "Unknown option: %s\n" "$1" >&2
            usage
            exit 1
            ;;
    esac
done


# ------------------------------
# 3. Localization Logic
# ------------------------------
LANG_TABLE='
TAG_INFO    | [INFO]  | [消息]
TAG_SUCCESS | [OK]    | [成功]
TAG_WARN    | [WARN]  | [注意]
TAG_ERROR   | [ERROR] | [错误]

MSG_DESC_TITLE    | The script will perform the following cleanup tasks:  | 本脚本将执行以下清理操作：
MSG_DESC_1        | 1. Remove orphaned packages                           | 1. 删除孤儿软件包
MSG_DESC_2        | 2. Clean package cache                                | 2. 清理软件包缓存
MSG_DESC_3        | 3. Vacuum systemd journal logs                        | 3. 清理 systemd 日志
MSG_DESC_4        | 4. Empty user Trash and thumbnail cache               | 4. 清空回收站和缩略图缓存
MSG_DESC_5        | 5. Remove unused Flatpak runtimes                     | 5. 删除未使用的 Flatpak 运行时
MSG_ASK_CONFIRM   | Continue with cleanup? [Y/n]                          | 是否继续执行清理？[Y/n]
MSG_ABORT         | Cleanup cancelled by user.                            | 用户已取消清理。
MSG_DONE          | System cleanup completed!                             | 系统清理完成！

MSG_NO_HELPER     | No AUR helper found (paru or yay required).           | 未找到 AUR 助手 (需要 paru 或 yay) 
MSG_HELPER_USE    | Using AUR helper: %s                                  | 使用 AUR 助手：%s
MSG_STEP_ORPHAN   | Checking for orphaned packages...                     | 正在检查孤儿软件包...
MSG_ORPHAN_FOUND  | Orphaned packages detected:                           | 发现孤儿软件包：
MSG_ORPHAN_CLEAN  | Orphaned packages removed.                            | 已删除孤儿软件包。
MSG_ORPHAN_NONE   | No orphaned packages found.                           | 未发现孤儿软件包。
MSG_STEP_CACHE    | Cleaning package cache...                             | 正在清理软件包缓存...
MSG_CACHE_DONE    | Package cache cleaned.                                | 软件包缓存已清理。
MSG_STEP_BROKEN   | Cleaning residual download directories...             | 正在清理残留下载目录...
MSG_BROKEN_DONE   | Residual directories removed.                         | 残留目录已清理。
MSG_STEP_LOG      | Vacuuming systemd journal logs...                     | 正在清理 systemd 日志...
MSG_LOG_DONE      | Systemd journal logs cleaned.                         | 系统日志已清理。
MSG_STEP_TRASH    | Cleaning user Trash and thumbnails...                 | 正在清理回收站和缩略图...
MSG_TRASH_DONE    | Trash emptied.                                        | 回收站已清空。
MSG_THUMB_DONE    | Thumbnails cleaned.                                   | 缩略图已清理。
MSG_STEP_FLATPAK  | Checking for unused Flatpak runtimes...               | 正在检查未使用的 Flatpak 运行时...
MSG_FLATPAK_DONE  | Unused Flatpak runtimes removed.                      | 未使用的 Flatpak 运行时已删除。
'
while IFS='|' read -r v e c; do
    v=$(printf "%s" "$v" | sed 's/^ *//;s/ *$//')
    e=$(printf "%s" "$e" | sed 's/^ *//;s/ *$//')
    c=$(printf "%s" "$c" | sed 's/^ *//;s/ *$//')
    [ -z "$v" ] && continue
    case "$v" in \#*) continue ;; esac
    [ "$UI_LANG" = "zh" ] && eval "$v=\$c" \
                          || eval "$v=\$e"
done <<EOF
$LANG_TABLE
EOF

# ------------------------------
# 4. Define Logging Functions
# ------------------------------
NC=$'\033[0m'
BLUE=$'\033[1;34m'
GREEN=$'\033[1;32m'
YELLOW=$'\033[1;33m'
RED=$'\033[1;31m'
_info()    { printf "%s%-12s%s %s\n" "${BLUE}"   "${TAG_INFO}"    "${NC}" "$1"; }
_success() { printf "%s%-12s%s %s\n" "${GREEN}"  "${TAG_SUCCESS}" "${NC}" "$1"; }
_warn()    { printf "%s%-12s%s %s\n" "${YELLOW}" "${TAG_WARN}"    "${NC}" "$1"; }
_error()   { printf "%s%-12s%s %s\n" "${RED}"    "${TAG_ERROR}"   "${NC}" "$1"; exit 1; }

# ------------------------------
# 5. Confirmation Prompt
# ------------------------------
if [ "$SKIP_CONFIRM" = false ]; then
    printf "\n%s=======================================================%s" "$BLUE" "$NC"
    printf "\n%s" "$MSG_DESC_TITLE"
    printf "\n%s" "$MSG_DESC_1"
    printf "\n%s" "$MSG_DESC_2"
    printf "\n%s" "$MSG_DESC_3"
    printf "\n%s" "$MSG_DESC_4"
    printf "\n%s" "$MSG_DESC_5"
    printf "\n%s=======================================================%s" "$BLUE" "$NC"
    printf "\n%s%s %s" "$YELLOW" "$MSG_ASK_CONFIRM" "$NC"
    read -r confirm
    case "$confirm" in
        [yY][eE][sS]|[yY])
            ;;
        *)
            printf "%s\n" "$MSG_ABORT"
            exit 0
            ;;
    esac
fi

# ------------------------------
# 6. Check AUR Helper
# ------------------------------
command -v paru &>/dev/null && AUR_HELPER=paru ||
command -v yay  &>/dev/null && AUR_HELPER=yay  ||
_error "$MSG_NO_HELPER"

# ------------------------------
# 7. Cleanup Function
# ------------------------------
_info "$(printf "$MSG_HELPER_USE" "$AUR_HELPER")"

# Keep Sudo Alive
sudo -v
( while true; do sudo -n true 2>/dev/null || exit; sleep 60 || exit; done ) &
SUDO_PID=$!
trap 'kill -- -$SUDO_PID 2>/dev/null || true' EXIT INT TERM

# [Step 1] Orphans
_info "$MSG_STEP_ORPHAN"
if ORPHANS=$(pacman -Qtdq); then
    printf "%s%s%s\n" "$YELLOW" "$MSG_ORPHAN_FOUND" "$NC"
    printf "%s\n" "$ORPHANS"
    echo "$ORPHANS" | xargs -r -d '\n' $AUR_HELPER -Rns --noconfirm --
    _success "$MSG_ORPHAN_CLEAN"
else
    _success "$MSG_ORPHAN_NONE"
fi

# [Step 2] Cache
_info "$MSG_STEP_CACHE"
$AUR_HELPER -Sc --noconfirm
_success "$MSG_CACHE_DONE"

# [Step 3] Broken Downloads
TARGET_DIR="/var/cache/pacman/pkg"
if [ -d "$TARGET_DIR" ]; then
    found=0
    while IFS= read -r -d '' dir; do
        [ "$found" -eq 0 ] && _info "$MSG_STEP_BROKEN" && found=1
        sudo rm -rf -- "$dir"
        printf "  Removed: %s\n" "$dir"
    done < <(find "$TARGET_DIR" -maxdepth 1 -type d -name "download-*" -print0 2>/dev/null)
    [ "$found" -eq 1 ] && _success "$MSG_BROKEN_DONE"
fi

# [Step 4] Journal
_info "$MSG_STEP_LOG"
sudo journalctl --vacuum-time=2weeks >/dev/null 2>&1
_success "$MSG_LOG_DONE"

# [Step 5] Trash & Thumbnails
_info "$MSG_STEP_TRASH"
TRASH_DIR="$HOME/.local/share/Trash"
THUMB_DIR="$HOME/.cache/thumbnails"

if [ -d "$TRASH_DIR" ]; then
    find "$TRASH_DIR" -mindepth 1 -delete
    _success "$MSG_TRASH_DONE"
fi

if [ -d "$THUMB_DIR" ]; then
    find "$THUMB_DIR" -type f -atime +30 -delete
    _success "$MSG_THUMB_DONE"
fi

# [Step 6] Flatpak
if command -v flatpak >/dev/null 2>&1; then
    _info "$MSG_STEP_FLATPAK"
    flatpak uninstall --unused -y >/dev/null 2>&1
    _success "$MSG_FLATPAK_DONE"
fi

printf "\n"
_success "$MSG_DONE"
